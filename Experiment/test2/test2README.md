# Test2—多个不同网络段的互联互通

## Experiment1

> 连接两个不同的网络

### Step

初始化两个网络，每个网络配置一个PC，每个PC连接一个交换机，PC配置各自IP

- PC1: 192.168.1.10
- PC2: 192.168.2.10

路由器用于连接不同网络，可以使用一个路由器将两个交换机连接，每个PC设置各自网关

- PC1: 192.168.1.1
- PC2: 192.168.2.1

路由器相应接口设置对应IP，两个不同的网络互联完成，PC1可以向PC2发送PDU

### Conclusion

数据包PDU具体传输过程：

- PC1发送ICMP包，源IP为192.168.1.10，目的IP为192.168.2.10
- 目的IP与源IP不处于同一网段，向网关发送数据包，但是PC1不知道网关MAC地址，因此PC1创建ARP包，源IP为192.168.1.10，目的IP为192.168.1.1，源MAC为PC1，目的MAC为广播（FF-FF-FF-FF-FF-FF），该ARP包通过交换机发送路由器，路由器接受ARP包后，返回ARP包，源IP为192.168.1.1，目的IP为192.168.1.10，源MAC为路由器MAC，目的MAC为PC1
- PC1接受路由器发送的ARP包后，发送最初的ICMP给路由器
- 路由器接收ICMP后，ICMP记录目的IP192.168.2.10，根据每个接口设置的IP，准备向PC2发送ICMP包，但是路由器不知道PC2的MAC地址，路由器需要发送ARP包去获取PC2的MAC地址，路由器作用是存储转发数据包，ICMP包没法转发出去，故直接丢弃ICMP包
- 路由器发送ARP广播包，PC2接受并返回ARP包，此时路由器已经知道PC2的MAC地址，之后PC1再向PC2发送数据包，不会丢包，路由器直接转发即可

上述为数据包的传输过程，整个过程，无论是ICMP还是ARP，数据包在每一个设备上的源及目的IP从未改变，而源与目的MAC一直在变。如果路由器不知道目的IP的MAC地址，第一次的数据包将会丢包

> 即使在路由器设置下一跳为PC2，仍然需要发送ARP包，下一跳服务于网络层，并不会记录MAC地址

![Photo1](images\Photo1.png)

![Photo2](images\Photo2.png)

## Experiment2

### Step

初始化四个网络，每个网络配置一个PC，每个PC连接一个交换机，PC配置各自IP

- PC1: 192.168.1.10
- PC2: 192.168.2.10
- PC3: 193.169.1.10
- PC4: 193.169.2.10

路由器用于连接不同网络，可以使用一个路由器将四个交换机连接，与上述实验相同，但是也可以使用两个路由器，一个路由器连接两个网络，接着将两个路由器连接，实现四个网络的互联互通，每个PC设置自己的网关(子网掩码均为24位)

- PC1: 192.168.1.1
- PC2: 192.168.2.1
- PC3: 193.169.1.1
- PC4: 193.169.2.1

路由器相应接口设置对应IP，路由器互连端口设置IP

- R1: 172.16.18.3
- R2: 172.16.19.4

四个不同的网络线路互联完成，不同PC之间还不可以实现PDU的转发

### Conclusion

**两路由器之间相连接的不是铜直通线，而是串行线**

PC1向PC3发送PDU

- 未设置路由表：PC1发送ICMP，不知道PC3的MAC地址，也不知道网关的MAC地址，先发送一个ARP广播包，寻找网关，网关返回ARP包，接着PC1向网关发送ICMP包，网关不知道PC3的MAC地址，将发来的ICMP包丢掉，也不知道由于路由表中未设置PC3的IP地址，网关会发一个ICMP给PC1，PDU转发失败

![Photo6](images\Photo6.png)

- 设置路由表：路由器内存有限，现在进行路由聚合，

  ```
  PC1:192.168.0000 0001.10
  PC2:192.168.0000 0010.10
  PC1和PC2的IP地址前22位相同，子网掩码为22位，现需要表示网络，故主机号全置0
  R2的路由表增加：网络：192.168.0.0；子网掩码：255.255.252.0；下一跳：172.16.18.3
  同理
  R1的路由表增加：网络：193.169.0.0；子网掩码：255.255.252.0；下一跳：172.16.19.4
  ```

  设置路由表之后，PDU可以正常转发

PC1第一次向PC3转发

与`Experiment1`类似，也会丢包，但是不同的是丢包发生在R2，因为R1收到ICMP包后，根据路由表，直接转发给R2，但是R2不知道PC3的MAC地址，会将ICMP包丢掉，发送一个ARP包，获取PC3的MAC地址，整个过程结束

![](images\Photo3.png)

PC1之后向PC3转发PDU，可以一步到位了

![](images\Photo4.png)

![](images\Photo5.png)
