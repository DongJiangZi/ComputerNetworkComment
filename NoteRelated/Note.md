# 计算机网络

## 2 计算机网络互联

### 2.1 计算机之间的连接方式

#### 2.1.1 两台计算机互联

使用**网线直连**实现两台计算机之间的互联，且两台计算机之间的网线需要使用**交叉线**，不是直通线

#### 2.1.5 路由器(Router)

之前的多台计算机互联，所连接设备必须处于同一网段之下，处在同一广播域之下，而路由器可以实现**不同网段之间转发数据**并且**隔绝广播域**

> 备注：
>
> 1. 主机发送数据之前，首先会判断目标主机IP地址是否与主机处于同一网段：若是，进行ARP广播，查找MAC，通过交换机或集线器传递数据；反之，主机向网关发送数据，由路由器传递数据
> 2. 广播域指的是网络中能够接收同一广播数据包的范围，即其中某一个设备进行广播，广播域中的所有设备都会接收这个广播包，而域外设备不会，集线器和二层交换机默认不会隔绝广播域，而路由器和三层交换机可以隔绝广播域

**路由器**有LAN口和WAN口，WAN口用于连接公网/广域网，WAN口有MAC地址和公网分配的IP地址，LAN口连接局域网，也有MAC地址和IP地址，两地址与WAN口均不相同，LAN口的IP地址是WAN口的IP地址通过NAT(Network Address Translation, 网络地址转换)得到的，路由器为局域网内的所有设备分配内网IP。

### 2.2 MAC地址

#### 2.2.1 MAC地址的特征格式

MAC: Media Access Control Address - 媒体访问控制地址

MAC地址由**6字节**数据组成，固化在网卡的ROM中，由IEEE802标准规定，结构图：

![](MAC.png)

OUI查询：

- https://standards-oui.ieee.org/oui/oui.txt
- https://mac.bmcx.com/

MAC地址表示格式：

- Windows：`40-55-82-0A-8C-6D`
- Linux、Android、Mac、iOS：`40:55:82:0a:8c:6d`
- Packet Tracker：`4055.820A.8C6D`
- 其中，`FF-FF-FF-FF-FF-FF`表示广播

#### 2.2.2 MAC地址的获取

本地主机向其他主机发送数据包，如果本地主机不知道对方主机的MAC地址，可以通过发送ARP(Address Resolution Protocol, 地址解析协议)广播获取对方主机MAC地址，成功获取会缓存对方主机IP与MAC地址的映射关系，即**ARP缓存**，通过ARP广播获取的MAC地址属于动态(dynamic)缓存，其存储时间较短（默认为2min），过期自动删除。

Example：

```
PC_A				PC_B
192.168.1.10		192.168.1.11
```

> PC_A向PC_B发送数据包，PC_A此时未缓存PC_B的MAC地址

```
src:192.168.1.10
dist:192.168.1.11
```

> PC_A的网络层确定数据包的源主机IP和目的主机IP

```
src:40-55-82-0A-8C-6D
dist:?
```

> PC_A的链路层不知道目的主机的MAC地址，此时发起ARP请求

```
ARP请求包:
src:40-55-82-0A-8C-6D
dist:FF-FF-FF-FF-FF-FF
data:i'am 192.168.1.10 which is 192.168.1.11
```

> ARP请求进行广播，非目的主机接收到ARP包不进行任何操作，目的主机接收到ARP包，返回一个ARP响应包，其中包含目的主机的MAC地址

```
ARP响应包：
src:B1-25-AA-7A-EC-59
dist:40-55-82-0A-8C-6D
data:xxx 192.168.1.11 mac B1-25-AA-7A-EC-59
```

> 返回到本地主机，本地主机执行ARP缓存，再发送最初要发送的数据包

相关命令：

- `arp -a [主机地址]`：查询ARP缓存
- `arp -d [主机地址]`：删除ARP缓存
- `arp -s 主机地址 MAC地址`：查询ARP缓存：增加一条缓存信息（其为静态缓存，存储时间久）

#### 2.2.3 ARP

**ARP**：Address Resolution Protocol, 地址解析协议，其用于实现从IP到MAC地址的映射，即询问目标IP对应的MAC地址的一种协议，ARP协议在IPv4中极其重要。ARP工作在链路层。

ARP工作流程见2.2.2中例子。

#### 2.2.4 ARP缓存

ARP缓存是为了降低网络流量的使用，一定程度上防止了ARP的大量广播。不仅仅 ARP 请求的发送方能够缓存 ARP 接收方的 MAC 地址，接收方也能够缓存 ARP 请求方的IP和MAC地址

ARP缓存包括主机名（对于一个IP地址）、硬件地址类型、硬件地址、标志和本地网络接口。其中，表示主要分为三类：C表示该缓存是由ARP协议动态学习；M表示该缓存是手动静态添加；P表示该设备可以响应其他设备的 ARP 请求，即它会代答（Proxy ARP）其他主机的请求，适用于代理 ARP（Proxy ARP）场景。

#### 2.2.5 RARP

RARP：Reverse Address Resolution Protocol，其实是反转ARP，从MAC地址定位IP地址的一种协议，将打印机服务器等小型嵌入式设备接入网络时会使用到。目前被BOOTP、DHCP所取代。

### 2.3 IP地址

>  已经有MAC地址成为了每一个上网设备的唯一标识，为什么要有IP地址？
>
>  与人类比，计算机网络中MAC地址就是设备的身份证，MAC地址确保了设备的唯一性，MAC地址标注了网卡是哪一批次出厂的，是批次里的哪一产品，但是MAC地址仅仅包含了网卡的出生地以及这个网卡是谁，当其他设备给该设备发送数据的时候，首先需要知道网卡现在在什么地方，接着需要核对接受数据的网卡是不是目的网卡，就像人线上购物的时候，发货方需要知道发到哪里去，送到目的地，接着核对收货人是否正确，IP地址在计算机网络中标识了数据接收方的“收货地址”

#### 2.3.1 IP地址定义

IP地址现今有两个版本：IPv4和IPv6

首先探讨**IPv4**，IPv4由32bit表示，为了便于阅读，8bit为一组，共四组，每组使用十进制进行表示，就是常见的IPv4：`xxx.xxx.xxx.xxx`，每组数据是8bit，因此每组数据大小范围是`[0, 255]`。

一台计算机可以有多个IP地址，可以是一个网卡设置多个IP，也可以是多个网卡设置多个IP，不同网卡具有不同的IP地址。

#### 2.3.2 IPv4地址的表示方法

> IPv4地址由因特网名字和数字分配机构(ICANN)进行分配，2011年2月3日IPv4地址全部分配完毕，中国在2014-2015不再分配IPv4地址，同时开始全面开展商用部署IPv6，但是部署并不容易：
>
> - 设备更新换代困难，设备庞杂
> - 部署之后还需要兼容IPv4
> - IPv6位数增加，CPU计算压力增大，对于机房等设备，需要重新设计架构

IPv4编址方法经历三个历史阶段：

1. 分类编址
2. 划分子网（改进分类编址）
3. 无分类编址（消除了分类编址和划分子网的概念）

**分类编址方法**

> 为什么要分类编址？
>
> 不同网络设备数量不同，通过控制网络号的程度进而控制主机号数量

32bit的IPv4地址由两部分组成：

- 网络号：标志主机（或路由器）的接口所连接到的网络。同一网络中，不同主机（或路由器）的接口IPv4地址的网络号必须相同，表示其属于同一网络
- 主机号：标志主机（或路由器）的接口。同一网络中，不同主机（或路由器）的接口IPv4地址的主机号必须各不相同，以区分各主机（或路由器）的接口

分类编址形式如下：

![](.\IP分类编址各类型格式.png)

> 备注：单播、广播、组播/多播
>
> - 单播：同一时间向一个设备发送数据
> - 广播：同一时间向同一网络里的所有设备发送数据
> - 组播/多播：同一时间向多个设备发送数据，多个设备add构成一个组播IP地址，发送数据的目的地是该组播IP地址，收到数据接收方需要判断自己是否是该组内的，如D类地址

其中，A、B和C类地址均为单播地址，只有单播地址可以分配给网络中的主机或路由器；D类地址用于多播，E类地址未定义用途，是IPv4预留的实验性地址，不用于普通网络。

主机号全为0的是网络地址（用于标识一个网网络），主机号全为1的是广播地址，两者不能分配给主机或路由器

| 网络类别 |          IP地址范围          | 可支持的最大网络数目 | 每个网络可支持的最大主机数目 | 适用的网络规模 |         私有IP地址范围         |
| :------: | :--------------------------: | :------------------: | :--------------------------: | :------------: | :----------------------------: |
|    A     |  1.0.0.0 -  126.255.255.255  |       2^7 - 2        |           2^24 - 2           |    大型网络    |   10.0.0.0 -  10.255.255.255   |
|    B     | 128.0.0.0 -  191.255.255.255 |         2^14         |           2^16 - 2           |    中型网络    |  172.16.0.0 -  172.31.255.255  |
|    C     | 192.0.0.0 -  223.255.255.255 |         2^21         |           2^8 - 2            |    小型网络    | 192.168.0.0 -  192.168.255.255 |

特殊IPv4地址：

| 网络号 |       主机号       | IP地址                                                       | 源地址 | 目的地址 | 含义                             |
| :----: | :----------------: | :----------------------------------------------------------- | ------ | :------: | :------------------------------- |
|   0    |         0          | 0.0.0.0                                                      | 可以   |  不可以  | 本网络中的本主机                 |
|   0    |      host-id       | 0.host-id                                                    | 可以   |  不可以  | 本网络中的某台主机               |
|  全1   |        全1         | 255.255.255.255                                              | 不可以 |   可以   | 在本网络进行广播                 |
| net-id |        全1         | A类：net-id.255.255.255<br />B类：net-id.255.255<br />C类：net-id.255 | 不可以 |   可以   | 对网络net-id上的所有主机进行广播 |
|  127   | 非全0或全1的任何数 | 127.0.0.1 - 127.255.255.224                                  | 可以   |   可以   | 用于本地软件环回测试             |

> 备注：
>
> 1. 255.255.255.255和net-id.255(.255.255)区别：
> 2. 127.x.x.x是回送地址，无论什么程序，一旦使用回送程序发送数据，协议软件立即返回，不进行任何网络传播，主要用于环回测试

**划分子网编址方法**

> 为什么划分子网？
>
> 分类编址中，同一网络下，能提供的主机IP数目固定，主机数目可能远小于该数量，容易造成IPv4地址资源浪费

子网掩码就是从主机号中借位给网络号使用，增加了网络号数据，避免IP地址浪费

子网掩码由32bit组成，左起连续多个bit1对应IP地址中的网络号和子网号；之后连续多个bit0对应主机号，每借一位子网数量乘二，子网里的主机号除二

**无分类编址方法**

取消地址分类，取消子网掩码传统写法，形式如下：

example：`128.14.35.7/20`其中最后的20表示该IP地址前20位为网络号，其余位为主机号，表示方式更加简便

#### 2.3.3 构造超网

> 为什么构造超网？
>
> 网络类型已经确定，即网络中主机数量已经确定，此时需要接入的主机数量超过上限，网络类型不改变，要满足需求数量，需要减少子网掩码的位数，向网络号借主机号

超网：主机号不足，向网络号借位

**超网的应用**

路由聚合：路由器`R1`接入五个设备，`R1`与路由器`R2`相连，各设备IP地址如下:

```
			R2路由表initial
———————————————————————————————————————
|device    dest			    nextHop   |
|  PC1	172.1.4.0/25		  R1	  |
|  PC2	172.1.4.128/25		  R1	  |
|  PC3	172.1.5.0/24		  R1	  |
|  PC4	172.1.6.0/24		  R1	  |
|  PC5	172.1.7.0/24		  R1	  |
———————————————————————————————————————
```

利用超网思维聚合`R2`路由表：

```
			R2路由表initial
——————————————————————————						
| 		 dest		     |
|172.1.0000 0100.0/25	 |
|172.1.0000 0100.128/25  |五个IP地址前22位相同		dest	
|172.1.0000 0101.0/24	 |——————————————————> 172.1.4.0/22
|172.1.0000 0110.0/24	 |对R2路由表进行聚合
|172.1.0000 0111.0/24	 |
——————————————————————————
```

构造超网，PDU目的地址属于该网段，下一跳就是`R1`，路由器`R2`路由表只需要记录一条信息，节省路由器的存储空间。

**如何判断是子网还是超网**

1. 判断网络类型，默认A类子网掩码位数是8位，B类子网掩码位数是16位，C类子网掩码位数是24位
2. 判断子网掩码位数
   比默认子网掩码多，就是子网
   比默认子网掩码少，就是超网

### 2.4 路由概述

#### 2.4.1 路由作用

- 在不同网段之间转发数据
- 默认情况下，路由只知道与其直连的网段，非直连的网段需要通过静态路由、动态路由
  - 静态路由：管理员手动添加路由信息，适用于小规模网络
  - 动态路由：路由器通过路由选择协议（如RIP、OSPF）自动获取路由信息，适用于大规模网络

#### 2.4.2 数据包传送过程

![](.\数据包传输过程示意图.png)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  

#### 2.4.3 因特网的公网和私网

- 公网
  - Internet上路由器中只有到达公网的路由表，没有到达私网的路由表
  - 公网IP由因特网信息中心(Internet Network Information Center，Inter NIC)统⼀分配和管理
  - ISP需要向Inter NIC申请公网IP
- 私网
  - 主要用于局域网
  - A类：10.0.0.0/8，1个A类网络
  - B类：172.16.0.0/16 ~ 172.31.0.0/16，16个B类网络
  - C类：192.168.0.0/24 ~ 192.168.255.0/24，256个C类网络

#### 2.4.4 NAT技术

私网IP访问Internet需要进行NAT(Network Address Translation)转换为公网IP，这一步由路由器实现，NAT特点为：

- 可以节约公网IP资源
- 会隐藏内部真实IP

NAT分类为：

- 静态转换：手动配饰NAT映射表
- 动态转换：定义外部地址池，动态随即转换，一对一转换
- PAT(Port Address Translation)，多对一转换
  - 采用端口多路复用技术

## 3 计算机网络的链路层

### 3.1 数据链路层概述

**链路**：是从一个节点到相邻节点的一段物理线路（有线或无线），**中间没有其他任何的交换节点**

**数据链路**基于链路，数据在链路上传播时，除链路外，还需要一些必要的通信协议来控制数据传输，链路+实现协议的硬件和软件=数据链路

不同类型的数据链路，所用通信协议不同：

- 广播信道：CSMA/CD协议（一般是网络边缘设备链路层使用的协议，比如集线器等组成的网络）
- 点对点协议：PPP协议（比如两个路由器之间的信道）

计算机中的网络适配器（网卡）与其软件驱动程序实现了这些协议，一般的网络适配器实现了物理层和数据链路层

### 3.2 数据链路层的三个问题

#### 3.2.1 封装成帧

帧(Frame)由三部分组成，帧首部、帧尾部和帧的数据部分（数据部分是网络层提供的数据包）

MTU(Maximum Transfer Unit, 最大传输单元)作用于帧的数据部分，其规定了帧的数据长度上限，每一种链路层协议都有MTU，以太网的MTU为1500字节

- 以太网V2的MAC帧

  ![以太网V2的MAC帧](.\以太网V2的MAC帧.png)

- PPP帧

  ![PPP帧](.\PPP帧.png)

封装成帧是指数据链路层为网络层传递的PDU添加一个首部和尾部变成帧

- 帧的首部和尾部中包含重要的控制信息
- 帧的首部和尾部作用之一就是帧定界（表示帧的开始与结束）
- 不是每一种数据链路层协议都包含帧定界表示，比如以太网V2的MAC帧，其帧首部不包含开始标志，而是有物理层给MAC帧添加一个前导码，前导码实现了帧定界

#### 3.2.2 透明传输

透明传输是指**数据链路层对网络层传递下来的PDU没有任何限制**，因为数据链路层大部分情况下需要表示帧开始和帧结束，PDU中的数据很容易和帧定界的数据相同，可能造成将PDU的数据当作帧结束标识，数据传输错误，为了解决这个问题，提出两种解决方法

- 面向字节的物理链路使用字节填充的方法实现透明传输，原理是在上层传递的PDU中，假设使用`2f`作为标识符，只要遇到与帧定界或者标识符`2f`相同的数据，就在该数据前添加`2f`表示此字节为数据内容，不是帧定界

  ![透明传输1](.\透明传输1.png)

- 面向比特的物理链路使用**比特填充**的方法实现透明传输，原理是假设`01111110`作为标识符，那么在数据内容中只要遇到连续五个`1`，就添加一个`0`，接收方相反操作，就可以实现数据准确传输

  ![透明传输2](.\透明传输2.png)

#### 3.2.3 差错检测

帧尾部中含有差错检测字段(FCS)，其是由首部+数据部分计算得出

#### 3.2.4 CRC循环冗余校验

链路层采用CRC循环冗余校验检错技术

基本思想：

- 收发双方约定好一个生成多项式`G(x)`
- 发送方基于待发送的数据和生成多项式`G(x)`，计算差错检测码（冗余码），将冗余码添加到发送数据后共同传输
- 接收方收到数据和冗余码后，通过检验判断是否产生了误码

发送方操作：

![](.\CRC发送方.png)

接收方操作：

![](.\CRC接收方.png)

### 3.3 Ethernet V2标准

以太网的帧最少为`64`字节

![](.\以太网帧.png)

数据最短长度 = 帧最短长度(64) - 目标MAC地址(6) - 源MAC地址(6) - 类型(2) - FCS(4) = 46

当数据长度小于46字节时，会填充部分字节在数据中，接收方会去掉添加的字节

 ### 3.4 PPP协议

#### 3.4.1 PPP概述

点对点协议(Point - to - Point, PPP) 是目前使用最广泛的点对点数据链路层协议，该协议的应用为因特网用户和广域网路由器链路

#### 3.4.2 PPP帧

![](.\PPP帧2.png)

- 标志(Flag)字段：帧的定界符，取值为`0x7E`
- 地址(Address)字段：取值为`0xFF`，预留（无作用）
- 控制(Control)字段：取值为`0x03`，预留（无作用）
- 协议(Protocol)字段：用于指明帧的数据载荷向上层何协议交付处理
- 帧检验序列(Frame Check Sequence, FCS)字段：使用循环冗余校验CRC计算得出 

## 4 网络层

### 4.1 网络层的设计选择

由于异构网络的组网方式、身份识别方式、数据校验方式不同，为了将不同的异构网络组成新的网络，在链路层之上利用网络层协议，实现异构网络的组网

网络层主要任务：将分组从源主机经过多个网络和多段链路传输到目的主机，其中分组转发和路由选择非常重要

网络层向上层提供了两种服务：

- 面向连接的虚电路服务
  - 核心思想：可靠通信有网络自身保证
  - 通信双方先建立虚电路，之后分组全部沿着该虚电路传输
- 无连接的数据报服务
  - 核心思想：可靠通信由用户主机保证
  - 每个分组无固定路径，传输完毕不需要释放连接

无连接的数据报服务，虽然可能导致误码、丢失、乱序，但是路由器设计简单，降低网络造价，提高了网络利用率

### 4.2 网络层协议 - IP协议

IP协议数据报格式：

![](.\IP协议.png)

1. 版本：4bit，用于表示IP协议的版本

   - `0b0100`：IPv4
   - `0b0110`：IPv6

2. 首部长度：4bit，该数值乘四用于表示数据报的首部长度

   - 最小取值：`0101`，表示首部长度为20**字节**
   - 最大取值：`1111`，表示首部长度为60字节

3. 可选字段：1字节~40字节不等，用于支持排错、测量以及安全措施等功能，特殊IP会使用该字段，虽然提升了协议功能，但是增加了路由器开销

4. 填充：当首部长度（20字节固定部分+可变部分）的长度不是4字节整数倍时，填充相应数量的全0字节，以确保IPv4数据报的首部长度是4字节的整数倍

5. 区分服务：8bit，用于提高网络服务，路由器可以根据区分服务确定数据报优先级

6. 总长度：16bit，表示首部+数据的长度之和，最大为65535，由于链路层支持的MTU为1500字节，过大的IP数据报需要分成片利用链路层传输，每一个片都有一个IP头

7. 标识：16bit，数据报ID，同一数据包的所有片标识都相同

8. 标志：3bit

   - 最高位：保留位，必须设置为0
   - 中间位(Don't Fragment, DF)
     - `DF = 1`表示不允许分片
     - `DF = 0` 表示允许分片
   - 最低位(More Fragment, MF)
     - `MF = 1` 表示该分片后还有分片
     - `MF = 0` 表示该分片后没有分片

9. 片偏移：13bit，该数值乘8表示该分片的在IP数据报中的起始位置，每一片的长度一定是8的整数倍

10. 生存周期：TTL，8bit，每个路由器在转发之前会将TTL减一，某路由器一旦发现该`TTL = 0`，将会直接丢包

11. 协议：8bit，表述数据载荷是何种协议数据单元，常用的协议与其协议字段值

    |  协议名称  | ICMP | IGMP | TCP  | UDP  | IPv6 | OSPF |
    | :--------: | :--: | :--: | :--: | :--: | :--: | ---- |
    | 协议字段值 |  1   |  2   |  6   |  17  |  41  | 89   |

    
